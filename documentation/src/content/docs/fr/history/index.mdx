---
title: "Historique"
description: "Suivez et consultez l'historique des déploiements pour chaque run de provisioning."
section: "History"
order: 5
---

# Historique des déploiements

VPS Setup enregistre automatiquement chaque run de provisioning dans un fichier de log par serveur. Cela vous donne une traçabilité complète de ce qui a été déployé, quand et avec quel profil.

## Fonctionnement de l'historique

Après chaque exécution de `vps-setup setup` — qu'elle soit réussie, échouée ou en mode dry-run — une entrée est ajoutée au fichier d'historique du serveur :

```
~/.config/vps-setup/history/<server-name>.log
```

Chaque entrée capture :

| Champ | Description |
|-------|-------------|
| `timestamp` | Date et heure ISO 8601 du run |
| `server` | Nom du serveur |
| `profile` | Profil utilisé pour le provisioning |
| `status` | Résultat : `success`, `failed`, ou `dry-run` |
| `duration` | Durée en secondes |
| `changes` | Nombre de tâches Ansible qui ont effectué des changements |
| `output` | Sortie brute Ansible (tronquée à 10 000 caractères en cas d'échec) |

## Consulter l'historique

### Tous les runs d'un serveur

```bash
vps-setup history prod-web
```

La sortie affiche la liste chronologique inverse de tous les runs de provisioning :

```
┌─ History: prod-web ────────────────────────────────────┐
  2024-01-20 14:22  full-stack   success   2m 34s   12 changes
  2024-01-18 09:11  minimal      success   0m 48s    3 changes
  2024-01-15 17:05  full-stack   failed    1m 02s    0 changes
```

### Les N derniers runs

```bash
vps-setup history prod-web --last 10
```

Affiche uniquement les 10 entrées les plus récentes.

## Statuts des entrées d'historique

| Statut | Signification |
|--------|---------------|
| `success` | Le playbook Ansible s'est terminé sans erreur |
| `failed` | Une ou plusieurs tâches Ansible ont échoué ou l'hôte était inaccessible |
| `dry-run` | Le provisioning a été simulé avec `--dry-run` ; aucun changement n'a été effectué |

## Politique de rétention

Par défaut, les entrées d'historique de plus de **30 jours** sont purgées automatiquement. Vous pouvez modifier ce paramètre dans la configuration globale :

```bash
# Conserver l'historique pendant 90 jours
vps-setup config set historyRetentionDays 90

# Désactiver la purge automatique
vps-setup config set historyRetentionDays 0
```

Voir la section [Configuration](/docs/fr/configuration) pour toutes les options disponibles.

## Format du fichier d'historique

L'historique est stocké en JSON délimité par des sauts de ligne (un objet JSON par ligne) :

```
~/.config/vps-setup/history/prod-web.log
```

```json
{"timestamp":"2024-01-20T14:22:00.000Z","server":"prod-web","profile":"full-stack","status":"success","duration":154,"changes":12}
{"timestamp":"2024-01-18T09:11:00.000Z","server":"prod-web","profile":"minimal","status":"success","duration":48,"changes":3}
{"timestamp":"2024-01-15T17:05:00.000Z","server":"prod-web","profile":"full-stack","status":"failed","duration":62,"changes":0,"output":"TASK [docker : Install docker-ce] ..."}
```

## Vérifier le statut d'un serveur

En complément de l'historique, vous pouvez vérifier le statut en direct d'un serveur :

```bash
vps-setup status prod-web
```

Cette commande effectue un test de connexion SSH et vérifie quels services sont en cours d'exécution. Elle n'ajoute pas d'entrée dans le log d'historique.

## Exemples pratiques

```bash
# Consulter l'historique complet d'un serveur de production
vps-setup history prod-web

# Consulter uniquement les 5 derniers runs
vps-setup history prod-web --last 5

# Référence croisée : quand ce serveur a-t-il été provisionné pour la dernière fois ?
vps-setup server show prod-web
# → lastProvisioned: 2024-01-20T14:22:00.000Z
```

## Remarques

- L'historique est par serveur. Il n'existe pas de vue agrégée inter-serveurs.
- Le champ `output` n'est stocké que lors des runs échoués, tronqué à 10 000 caractères.
- Les entrées dry-run sont enregistrées avec `status: dry-run` afin de pouvoir auditer les simulations séparément.
