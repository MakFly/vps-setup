---
import BaseLayout from "./BaseLayout.astro";
import Sidebar from "@/components/docs/Sidebar";
import MobileSidebar from "@/components/docs/MobileSidebar";
import TableOfContents from "@/components/docs/TableOfContents";
import Search from "@/components/docs/Search";
import Breadcrumbs from "@/components/docs/Breadcrumbs.astro";
import Pagination from "@/components/docs/Pagination.astro";
import LanguageSwitcher from "@/components/docs/LanguageSwitcher";
import ThemeToggle from "@/components/docs/ThemeToggle";
import { getSidebarTree } from "@/lib/docs";
import { getLocaleFromUrl, useTranslations } from "@/i18n/utils";
import type { SidebarGroup } from "@/lib/docs";

interface Props {
  title: string;
  description?: string;
  headings?: { depth: number; slug: string; text: string }[];
  prevPage?: { title: string; slug: string } | null;
  nextPage?: { title: string; slug: string } | null;
}

const { title, description, headings = [], prevPage, nextPage } = Astro.props;
const lang = getLocaleFromUrl(Astro.url);
const t = useTranslations(lang);
const sidebarTree = await getSidebarTree(lang);
const currentSlug = Astro.url.pathname;
---

<BaseLayout title={title} description={description}>
  <div class="flex min-h-screen">
    <!-- Desktop Sidebar -->
    <aside class="hidden lg:block w-[250px] shrink-0 border-r border-border">
      <div class="sticky top-0 h-screen overflow-hidden flex flex-col">
        <div class="p-4 border-b border-border">
          <a href={`/${lang}`} class="text-lg font-bold">{t("site.title")}</a>
        </div>
        <div class="p-2">
          <Search client:idle lang={lang} placeholder={t("search.placeholder")} />
        </div>
        <div class="flex-1 overflow-y-auto p-4">
          <Sidebar client:load groups={sidebarTree} currentSlug={currentSlug} lang={lang} />
        </div>
        <div class="p-4 border-t border-border flex items-center gap-2">
          <LanguageSwitcher client:load lang={lang} pathname={Astro.url.pathname} />
          <ThemeToggle client:load />
        </div>
      </div>
    </aside>

    <!-- Main content area -->
    <div class="flex-1 min-w-0">
      <!-- Mobile header -->
      <header class="lg:hidden sticky top-0 z-40 flex items-center gap-2 border-b border-border bg-background px-4 h-14">
        <MobileSidebar client:load groups={sidebarTree} currentSlug={currentSlug} lang={lang} siteName={t("site.title")} />
        <span class="font-bold">{t("site.title")}</span>
        <div class="ml-auto flex items-center gap-2">
          <LanguageSwitcher client:load lang={lang} pathname={Astro.url.pathname} />
          <ThemeToggle client:load />
        </div>
      </header>

      <div class="flex">
        <!-- Content -->
        <main class="flex-1 min-w-0 max-w-3xl mx-auto px-6 py-8" data-pagefind-body>
          <Breadcrumbs />
          <h1 class="text-3xl font-bold mb-2">{title}</h1>
          {description && <p class="text-muted-foreground mb-8 text-lg">{description}</p>}
          <div class="prose prose-slate dark:prose-invert max-w-none">
            <slot />
          </div>
          <Pagination prevPage={prevPage} nextPage={nextPage} lang={lang} />
        </main>

        <!-- Desktop TOC -->
        {headings.length > 0 && (
          <aside class="hidden xl:block w-[200px] shrink-0">
            <div class="sticky top-0 py-8 pr-4">
              <TableOfContents client:visible headings={headings} title={t("toc.title")} />
            </div>
          </aside>
        )}
      </div>
    </div>
  </div>
</BaseLayout>
